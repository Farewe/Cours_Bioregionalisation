---
title: "TP bioregionalisation avec la diversité beta"
author: "Boris Leroy, UMR BOREA, Muséum National d'Histoire Naturelle"
output: html_document
editor_options: 
  chunk_output_type: inline
---

**ATTENTION** ce document n'est plus à jour

# Chargez les packages



```{r echo=TRUE,message=FALSE,warning=FALSE}
library(bioregion)
library(sf)
library(vegan)
library(rnaturalearth)
```

# 1. Chargement des données

```{r}
# Occurrence database
subtidaldb <- readRDS("./data/invertebres_benthiques.RDS")


# Site position
sites <- readRDS("./data/sites_invertebresbenthiques.RDS")
```

# 2. Calcul des distances entre bassins avec l’indice ßsim [3]

```{r}
dist_subtidal <- dissimilarity(t(as.matrix(subtidaldb)))


```

# 3. Visualisation des distances entres sites
```{r fig.width=8, fig.height=8}
matrix_dist <- net_to_mat(dist_subtidal,
                          weight = TRUE, squared = TRUE, symmetrical = TRUE)
matrix_dist <- as.dist(matrix_dist)

subtidal_nmds <- metaMDS(matrix_dist, center=TRUE)
plot(subtidal_nmds)
```

Qu'observez-vous sur la NMDS ? Comment est distribuée la diversité beta ? Semble-t-il y avoir un effet spatial ou pas ? 

Il semble y avoir un gradient de dissimilarité entre les sites situés autour de la Bretagne. D'une manière générale, plus les sites sont proches spatialement, plus ils semblent similaires. Cependant il y a des exceptions, notamment dans la rade de Brest ou au niveau de Lannion, où des sites très proches semblent parfois être très dissimilaires, ce qui ne peut donc uniquement être expliqué par la proximité spatiale.

# 4. Faire la classification ascendante hiérarchique 

```{r}
hclust_subtidal <- hclu_hierarclust(dist_subtidal)

plot(hclust_subtidal)
```

La dissimilarité entre les sites est assez faible, inférieure à 0.4, et plutôt de l'ordre de 0.1 à 0.3. Cela signifie que les sites partagent un grand nombre d'espèces en commun, et donc la répartition en groupe impliquera des groupes faiblement différents dans leur composition en espèces.


# 5. Evaluer la qualité de la classification consensus

```{r}
hclust_subtidal
```

La valeur de corrélation cophénétique de l'arbre est affichée dans le résumé ci-dessus. Cette valeur indique à quel point l'arbre hiérarchique représente fidèlement les distances originales entre sites. Plus elle est proche de 1, meilleure est la représentation. Dans notre cas, la valeur est assez faible, ce qui indique que l'arbre ne représente pas complètement bien les relations entre les sites.

L'arbre étant une simplification de la matrice de distance, il existe toujours un certain degré de perte d'information, mais l'algorithme IHCT minimise cette perte en construisant un arbre consensus robuste basé sur la décision majoritaire à travers de nombreuses randomisations.

# 6. Rechercher la hauteur à laquelle couper l'arbre

```{r}
hclust_subtidal <- cut_tree(hclust_subtidal,
                            n_clust = 2:50)
summary(hclust_subtidal)
```

```{r}
eval_partitions <- bioregionalization_metrics(hclust_subtidal,
                                     dissimilarity = dist_subtidal,
                                     eval_metric = "pc_distance")

# Tester trois seuils : 40%, 50% et 60%
optimal_40 <- find_optimal_n(eval_partitions, criterion = "cutoff", 
                             metric_cutoffs = 0.40)
optimal_50 <- find_optimal_n(eval_partitions, criterion = "cutoff", 
                             metric_cutoffs = 0.50)
optimal_60 <- find_optimal_n(eval_partitions, criterion = "cutoff", 
                             metric_cutoffs = 0.60)

cat("Seuil 40% :", optimal_40$optimal_nb_clusters$pc_distance, "clusters\n")
cat("Seuil 50% :", optimal_50$optimal_nb_clusters$pc_distance, "clusters\n")
cat("Seuil 60% :", optimal_60$optimal_nb_clusters$pc_distance, "clusters\n")


hclust_subtidal <- cut_tree(hclust_subtidal,
                            n_clust = c(optimal_40$optimal_nb_clusters$pc_distance,
                                optimal_50$optimal_nb_clusters$pc_distance,
                                optimal_60$optimal_nb_clusters$pc_distance))

summary(hclust_subtidal)
```

Avec le seuil à 50%, nous obtenons `r optimal_50$optimal_nb_clusters$pc_distance` clusters, et la hauteur de coupe est de `r round(hclust_subtidal$cluster_info$output_cut_height, 3)`. La fonction `summary()` permet d'afficher la hiérarchie des clusters de manière claire.



# 7. Faire la carte des clusters obtenus

```{r}
# Transformer les sites en objet sf
sites_sf <- st_as_sf(sites,
                     coords = c("X", "Y"),
                     crs = "EPSG:4326")

# Ajouter automatiquement des couleurs aux clusters
hclust_colored <- bioregion_colors(hclust_subtidal, 
                                   palette = "Vivid",
                                   cluster_ordering = "n_sites")

# Créer la carte avec map_bioregions
# Mettez scale = 50 dans la ligne ci-dessous si vous n'arrivez pas à lancer la commande
wm <- ne_coastline(scale = 10, returnclass = "sf")
map_bioregions(hclust_colored, sites_sf, bioregionalization = 1,
               reset = FALSE,
               pch = 16)

# Ajouter le trait de côte
plot(wm[1], add = TRUE)
```

Décrivez le résultat que vous obtenez : 

- Semble-t-il y avoir différents clusters ?

On trouve différents clusters, même s'ils sont, au final, assez peu dissimilaires (cf. illustration de l'arbre à l'étape #5). Retenez que, la méthode de Holt (ou tout autre méthode similaire) vous donnera toujours des clusters. Ces clusters peuvent avoir un sens biologique, mais n'oubliez pas la hauteur à laquelle vous avez coupé l'arbre. Ici, la hauteur d'environ 0.3 indique que pour appartenir à des clusters différents, les sites ne doivent avoir en moyenne que 30% de dissimilarité. Ce seuil peut sembler faible, mais il s'agit d'une étude à l'échelle régionale, et donc il est cohérent qu'il soit faible comparé à des analyses à échelles plus larges où les faunes sont plus dissimilaires et donc où le seuil tournera à des valeurs bien élevées. 

- Comment sont-ils distribués ? 

Les sites proches sont généralement dans les mêmes clusters, tandis que les sites éloignés sont dans des clusters différents. Cependant, on note qu'il existe des sites parfois très proches qui peuvent appartenir à des clusters différents (rade de Brest, Ouessant, Lannion).

- Est-ce que les sites sont assemblés en clusters en suivant un patron spatial évident ? 

En général oui, avec des différences notables localement.

- Est-il possible que d'autres facteurs expliquent les clusters identifiés pour les sites ?

Oui, car des sites proches sont dans des clusters très différents. Une analyse des clusters en fonction des paramètres environnementaux permettrait de le démontrer. En l'occurrence, la turbidité, l'exposition des tombants, leur degré de perturbation peuvent expliquer l'appartenance à différents clusters.


- Quelles difficultés éprouvez-vous à l'interprétation ? Comment faudrait-il y remédier ?

Il y a trop de clusters et les couleurs sont trop proches ce qui rend l'interprétation très difficile. Il faudrait réduire le nombre de clusters, ou bien les représenter séparément pour bien visualiser quels clusters sont distribués où.
