---
title: "TP bioregionalisation avec les réseaux"
author: "Boris Leroy, UMR BOREA, Muséum National d'Histoire Naturelle"
output: html_document
editor_options: 
  chunk_output_type: inline
---




```{r message=FALSE, warning=FALSE}
# pak::pkg_install("bioRgeo/bioregion", ask = TRUE)   

library(bioregion)
install_binaries(binpath = "c:/r")
```


# 1. Chargement des données (bases poissons et polygones spatialisés des bassins)

```{r}
# Packages
library(bioregion)
library(sf)
library(plyr)
library(RColorBrewer)

# Répertoire de travail
# setwd("d:/r/projects/Cours_Bioregionalisation/")

# Shapefiles
basins <- st_read("./data/data_cours/basin_simplif.shp")

# Occurrence databases
fishdb1 <- readRDS("./data/data_cours/fishdb1.RDS")
fishdb2 <- readRDS("./data/data_cours/fishdb2.RDS")
```


# 3. Rechercher les clusters sur le réseau

```{r}

fish_clusters1 <- netclu_infomap(net = fishdb1,
                                 weight = FALSE,
                                 binpath = "c:/r",
                                 numtrials = 100,
                                 show_hierarchy = TRUE,
                                 bipartite = TRUE,
                                 bipartite_version = FALSE,
                                 site_col = "Basin",
                                 species_col = "Species",
                                 seed = 123)
```


# 3.2. Première lecture et interprétation du résultat

```{r}
fish_clusters1
```

**Question** : combien de niveaux avez-vous ? Combien de clusters à chaque niveau ?

Il y a `r nrow(fish_clusters1$cluster_info)` niveaux. Au premier niveau, il y a `r fish_clusters1$cluster_info$n_clust[1]` clusters ; au deuxième niveau il y a `r fish_clusters1$cluster_info$n_clust[2]` clusters ; au troisième niveau, `r fish_clusters1$cluster_info$n_clust[3]` clusters et au quatrième niveau, `r fish_clusters1$cluster_info$n_clust[4]` clusters.


**Question** : combien y a-t-il de sites et d'espèces par cluster pour la première partition ? Qu'en déduisez-vous pour les régions biogéographiques ? 

```{r}
summary(fish_clusters1)
```
Il y a deux clusters principaux avec près de 6000 noeuds (ce sont des super-régions), et un tout petit cluster de 15 noeuds.

Pour le deuxième niveau :
4 clusters principaux (4 grandes régions) dans le cluster 1, 2 clusters principaux dans le cluster 2, et toujours notre petit cluster marginal.


# 4. Analyser séparément les sites et les espèces

**Question :**
Faites un histogramme du nombre de sites par cluster dans les deux premières partitions.
Faites la même pour le nombre d'espèces par cluster.


La commande summary donne déjà cette information, mais on peut aussi l'obtenir avec la fonction `count` du package `plyr`.
```{r}
library(ggplot2)
clusters1 <- fish_clusters1$clusters
site_clusters1 <- clusters1[which(clusters1$ID %in% fishdb1$Basin), ]
sites_p1 <- plyr::count(site_clusters1[2])
ggplot(sites_p1, aes(x = K_3, y = freq)) +
  geom_bar(stat = "identity") +
  labs(x = "Cluster", y = "Nombre de sites") +
  theme_minimal() +
  ggtitle("Nombre de site par clusters - niveau 1")

sites_p2 <- plyr::count(site_clusters1[3])
ggplot(sites_p2, aes(x = K_7, y = freq)) +
  geom_bar(stat = "identity") +
  labs(x = "Cluster", y = "Nombre de sites") +
  theme_minimal() +
  ggtitle("Nombre de site par clusters - niveau 2")

```
On voit que les 2 grands clusters du niveau 1 et les 6 grands clusters du niveau 2 ont tous un grand nombre de sites, comparables en taille. En revanche, le petit cluster n'a qu'un seul site - il s'agit probablement d'une zone avec des espèces endémiques trouvées nulle part ailleurs dans le monde. 


```{r}
species_clusters1 <- clusters1[which(clusters1$ID %in% fishdb1$Species), ]
species_p1 <- plyr::count(species_clusters1[2]) # 2e colonne = première partition / premier niveau
ggplot(species_p1, aes(x = K_3, y = freq)) +
  geom_bar(stat = "identity") +
  labs(x = "Cluster", y = "Nombre d'espèces") +
  theme_minimal() +
  ggtitle("Nombre d'espèces par clusters - niveau 1")

species_p2 <- plyr::count(species_clusters1[3]) # 3e colonne = deuxième partition / second niveau
ggplot(species_p2, aes(x = K_7, y = freq)) +
  geom_bar(stat = "identity") +
  labs(x = "Cluster", y = "Nombre d'espèces") +
  theme_minimal() +
  ggtitle("Nombre d'espèces par clusters - niveau 2")

```
Les 2 clusters de niveau 1 sont à peu près équilibré en nombre d'espèces, tandis que les clusters de niveau 2 sont plus déséquilibrés : il y a des régions très riches (jusque 4700 espèces), et d'autres très pauvres (seulement 400 espèces).

# 5. Faites une carte des régions
## 5.1 Assigner une couleur à chaque région

```{r}
fish_clusters1 <- bioregion_colors(fish_clusters1,
                                   palette = "Safe",
                                   cluster_ordering = "n_both")
```


## 5.2 Faire la carte

```{r}
map_bioregions(clusters = fish_clusters1,
               geometry = basins,
               bioregionalization = 2)
```

# 6. Ecrire le réseau biogéographique pour Gephi

```{r}
exportGDF(df = fishdb1,
          col1 = "Basin",
          col2 = "Species",
          weight = NULL,
          bioregions = fish_clusters1,
          bioregionalization = 2,
          file = "data/fish1.gdf")
```

# 7. Analysez le réseau biogéographique sous gephi

La visualisation sous Gephi se fait à partir du fichier généré à l'étape 6.

# 8. Refaites l'analyse pour la seconde base de données

```{r}
fish_clusters2 <- netclu_infomap(net = fishdb2,
                                 weight = FALSE,
                                 binpath = "c:/r",
                                 numtrials = 100,
                                 show_hierarchy = TRUE,
                                 bipartite = TRUE,
                                 bipartite_version = FALSE,
                                 site_col = "Basin",
                                 species_col = "Species",
                                 seed = 123)
fish_clusters2

summary(fish_clusters2)
fish_clusters2 <- bioregion_colors(fish_clusters2,
                                   palette = "Vivid",
                                   cluster_ordering = "n_both")


png("comparison_map.png", width = 800, height = 400)
par(mfrow = c(1,2))
map_bioregions(clusters = fish_clusters1, 
               geometry = basins,
               bioregionalization = 2,
               main = "fishdb1")


map_bioregions(clusters = fish_clusters2,
               geometry = basins,
               bioregionalization = 1,
               main = "fishdb2")
dev.off()

exportGDF(df = fishdb1,
          col1 = "Basin",
          col2 = "Species",
          weight = NULL,
          bioregions = fish_clusters1,
          bioregionalization = 1,
          file = "data/fish1.gdf")
```

**Question**
Qu'est-ce qui peut expliquer la différence entre les deux bases de données ?

La différence est due au fait que la base fishdb2 intègre les occurrences d'introduction par l'homme des poissons d'eau douce, ce qui masque les patrons naturels et change la forme des régions biogéographiques de poissons d'eau douce.


# 9. Calculer et comparer les métriques d'endemisme entre les deux bases de données
```{r}
endemism1 <- bioregionalization_metrics(bioregionalization = fish_clusters1,
                                        net = fishdb1,
                                        eval_metric = c("avg_endemism", "tot_endemism"))

endemism2 <- bioregionalization_metrics(bioregionalization = fish_clusters2,
                                        net = fishdb2,
                                        eval_metric = c("avg_endemism", "tot_endemism"))
# Endémisme des régions naturelles
endemism1$evaluation_df
# Endémisme des régions avec les introductions
endemism2$evaluation_df

```

On note une diminution très forte de l'endémisme moyen par région (= nombre moyen d'espèces endémiques par site) à cause des introductions d'espèces par l'homme. Le total d'espèces endémiques est aussi plus faible, mais dans une moindre mesure.

Analyse du détail :

```{r}
# Détail de l'endémisme par région
endemism1$endemism_results
```


# 10. (facultatif) Faites une belle carte ʕ◠ᴥ◠ʔ

```{r message=FALSE, warning=FALSE}
library(lwgeom)
library(ggplot2)
library(rnaturalearth)

# On va utiliser la projection du National Geographic: Winkel Tripel
# Pour cela il faut utiliser le package lwgeom qui permet des projections additionnelles avec sf

# Graticule
gr <- sf::st_graticule(lat = c(-89.9,seq(-80,80,20), 89.9))
# Projection du graticule en wintri
gr <- st_transform_proj(gr, 
                        crs = "+proj=wintri")

# Trait de cote
wm <- ne_coastline(scale = 50, returnclass = "sf")
# Projection
wm <- st_transform_proj(wm, 
                        crs = "+proj=wintri")


# Projection des bassins en wintri
basins <- st_transform_proj(basins, 
                             crs = "+proj=wintri")

basins$color1 <- 
  fish_clusters1$clusters_colors[
        match(basins$BasinName, 
              fish_clusters1$clusters_colors$ID), 3] # couleur du niveau 2
basins$color2 <- 
  fish_clusters2$clusters_colors[
        match(basins$BasinName, 
              fish_clusters2$clusters_colors$ID), 2] # couleur du niveau 1                                

ggplot() +
  geom_sf(data = gr, color = 'grey', # graticule
          size = .5) +
  geom_sf(data = wm, col = grey(.6), fill = grey(.9), # continents
          size = .2) +
  geom_sf(data = basins, aes(fill = color1), # bassins avec couleurs des régions
          size = .05) +
  theme_minimal() + # thème simplifié pour ggplot2
  coord_sf(datum = NA) + # obligatoire pour pouvoir utiliser les projections de lwgeom
  scale_fill_identity()  # pour que ggplot utilise bien les couleurs qu'on lui demande


ggplot() +
  geom_sf(data = gr, color = 'grey', # graticule
          size = .5) +
  geom_sf(data = wm, col = grey(.6), fill = grey(.9), # continents
          size = .2) +
  geom_sf(data = basins, aes(fill = color2), # bassins avec couleurs des régions
          size = .05) +
  theme_minimal() + # thème simplifié pour ggplot2
  coord_sf(datum = NA) + # obligatoire pour pouvoir utiliser les projections de lwgeom
  scale_fill_identity()  # pour que ggplot utilise bien les couleurs qu'on lui demande

```


