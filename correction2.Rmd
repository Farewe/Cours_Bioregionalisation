---
title: "TP bioregionalisation avec les réseaux"
author: "Boris Leroy, UMR BOREA, Muséum National d'Histoire Naturelle"
output: html_document
editor_options: 
  chunk_output_type: inline
---


# 0. Installation de bioregion biogeonetworks

```{r}
library(bioregion)
install_binaries(binpath = "c:/r")
```


# 1. Chargement des données (bases poissons et polygones spatialisés des bassins)

```{r}
# Packages
library(bioregion)
library(biogeonetworks)
library(sf)
library(plyr)
library(RColorBrewer)

# Répertoire de travail
# setwd("d:/r/projects/Cours_Bioregionalisation/")

# Shapefiles
basins <- st_read("./data/data_cours/basin_simplif.shp")

# Occurrence databases
fishdb1 <- readRDS("./data/data_cours/fishdb1.RDS")
fishdb2 <- readRDS("./data/data_cours/fishdb2.RDS")
```


# 2. Rechercher les clusters sur le réseau

```{r}

fish_clusters1 <- netclu_infomap(net = fishdb1,
                                 weight = FALSE,
                                 binpath = "c:/r",
                                 show_hierarchy = TRUE,
                                 bipartite = TRUE,
                                 bipartite_version = FALSE,
                                 site_col = "Basin",
                                 species_col = "Species")
```


# 2. Première lecture et interprétation du résultat

```{r}
fish_clusters1
```

Question : combien de niveaux avez-vous ? Combien de clusters à chaque niveau ?

Il y a `r nrow(fish_clusters1$cluster_info)` niveaux. Au premier niveau, il y a `r fish_clusters1$cluster_info$n_clust[1]` clusters ; au deuxième niveau il y a `r fish_clusters1$cluster_info$n_clust[2]` clusters ; au troisième niveau, `r fish_clusters1$cluster_info$n_clust[3]` clusters et au quatrième niveau, `r fish_clusters1$cluster_info$n_clust[4]` clusters.


Question : combien y a-t-il de sites et d'espèces par cluster pour la première partition ? Qu'en déduisez-vous pour les régions biogéographiques ? 

```{r}
plyr::count(fish_clusters1$clusters[, 2])
```
Il y a deux clusters principaux avec près de 6000 noeuds (ce sont des super-régions), et un tout petit cluster de 15 noeuds.


Faites la même analyse pour la deuxième partition (= deuxième niveau hiérarchique).

```{r}
plyr::count(fish_clusters1$clusters[, 3])
```
Il y a six clusters principaux (six grandes régions), et toujours notre petit cluster marginal.


# 3. Analyser séparément les sites et les espèces

Combien y a-t-il de sites par cluster dans les deux premières partitions ?
```{r}
clusters1 <- fish_clusters1$clusters
site_clusters <- clusters[which(clusters1$ID %in% fishdb1$Basin), ]
plyr::count(site_clusters[2])
plyr::count(site_clusters[3])
```
On voit que les 2 grands clusters du niveau 1 et les 6 grands clusters du niveau 2 ont tous un grand nombre de sites, comparables en taille. En revanche, le petit cluster n'a qu'un seul site - il s'agit probablement d'une zone avec des espèces endémiques trouvées nulle part ailleurs dans le monde. 


Combien y a-t-il d'espèces par cluster dans les deux premières partitions ?
```{r}
species_clusters <- clusters[which(clusters1$ID %in% fishdb1$Species), ]
plyr::count(species_clusters[2])
plyr::count(species_clusters[3])
```

Les 2 clusters de niveau 1 sont à peu près équilibré en nombre d'espèces, tandis que les clusters de niveau 2 sont plus déséquilibrés : il y a des régions très riches (jusque 4700 espèces), et d'autres très pauvres (seulement 400 espèces).

# 4. Faites une carte des régions
## 4.1 Créer un tableau avec les couleurs pour chaque cluster

```{r}
# On commence par récupérer les noms des clusters de la partition de niveau 2
# En regardant le tableau des clusters on voit qu'il s'agit de la 3e colonne
clusters.lvl2 <- unique(clusters1[, 3])
clusters.lvl2


# Ensuite, on crée un tableau avec les couleurs sur la deuxième colonne
bioregions <- data.frame(
  clusters = clusters.lvl2, # La première colonne contient les clusters
  # La deuxième colonne contient les couleurs
  colors = brewer.pal(length(clusters.lvl2), # On veut autant de couleurs que de clusters
                      "Set2") # J'ai demandé la palette "Set2" ici, allez voir sur colorbrewer2.org pour voir les différents types de palettes existant
)

bioregions
```


## 4.2 Ajouter les couleurs dans le tableau des clusters

```{r}
clusters1$color <- bioregions$colors[match(clusters1[, 3],
                                           bioregions$clusters)]
```

## 4.3 Ajouter les couleurs dans l'objet spatial pour faire la carte

```{r}
basins$color <- clusters1$color[match(basins$BasinName,
                                      clusters1$ID)]

plot(basins[1],
     col = basins$color)
```




```{r}
system("./infomap ./data/fishdb1.net ./data/ --tree -N 10")
```


# 4. Lire l'arbre et les clusters créés par Map Equation sous R

```{r}
fish.net1 <- readInfomapTree("./data/fishdb1.tree")
```

La fonction nous informe que le réseau a une hiérarchie de 4 niveaux, avec 5 clusters identifiés au niveau 1.


# 5. Analyser séparément les sites et les espèces

```{r}
fish.sites1 <- getSiteTable(fishdb1, site.field = "Basin", network = fish.net1)
fish.species1 <- getSpeciesTable(fishdb1, species.field = "Species", network = fish.net1)

head(fish.sites1)
count(fish.sites1$lvl1)
count(fish.species1$lvl1)
```

On observe que les 5 clusters du niveau 1 sont hétérogènes. Certains clusters contiennent beaucoup de bassins et sont très riches, tandis que d'autres ont peu de bassins et sont peu riches. S'agissant d'étudier les grandes régions biogéographiques, nous allons limiter notre analyse aux clusters qui ont beaucoup de bassins et beaucoup d'espèces. Les 4 premiers clusters ont plus de 100 bassins versants et plus de 200 espèces, donc nous travaillerons avec ces 4 clusters ici, mais vous pouvez choisir un chiffre différent (et vos résultats peuvent différer - MapEquation fonctionne sur un processus aléatoire donc il faut faire des répétitions).

Le chiffre que vous choisirez n'a pas beaucoup d'impact à ce stade car il va servir aux couleurs sur les cartes (les clusters principaux seront colorés, tandis que les clusters secondaires seront en gris dans notre exemple).

# 6. Attribuer des couleurs aux grandes régions


```{r}
fish.net1 <- attributeColors(fish.net1, nb.max.colors = 4, db = fishdb1)
fish.sites1 <- attributeColors(fish.sites1, nb.max.colors = 4, db = fishdb1)
```


# 7. Affichez la carte des bassins avec les couleurs des régions

```{r}
basins$color1 <- fish.net1$color[match(basins$BasinName, fish.net1$Name)]
plot(basins[1], col = basins$color1)
```


# 8. Ecrire le réseau biogéographique pour Gephi


```{r}
writeGDF(fishdb1, fish.net1, site.field = "Basin", species.field = "Species", color.field = "color",
         filename = "./data/fishnet1.gdf")
```



# 9. Analysez le réseau biogéographique sous gephi

# 10. Refaites l'analyse pour la seconde base de données

```{r}
writePajek(fishdb2, 
           site.field = "Basin",
           species.field = "Species",
           filename = "./data/fishdb2.net")

system("./infomap ./data/fishdb2.net ./data/ --tree -N 10")

fish.net2 <- readInfomapTree("./data/fishdb2.tree")


fish.sites2 <- getSiteTable(fishdb2, site.field = "Basin", network = fish.net2)
fish.species2 <- getSpeciesTable(fishdb2, species.field = "Species", network = fish.net2)

head(fish.sites2)
count(fish.sites2$lvl1)
count(fish.species2$lvl1)

fish.net2 <- attributeColors(fish.net2, nb.max.colors = 3, db = fishdb2)
fish.sites2 <- attributeColors(fish.sites2, nb.max.colors = 3, db = fishdb2)

basins$color2 <- fish.net2$color[match(basins$BasinName, fish.net2$Name)]

op <- par(mfrow = c(2, 1), mar = c(1.1, 1.1, 1.1, 1.1))
plot(basins[1], col = basins$color1)
plot(basins[2], col = basins$color2)
par(op)

writeGDF(fishdb2, fish.net2, site.field = "Basin", species.field = "Species", color.field = "color",
         filename = "./data/fishnet2.gdf")
```


**Qu'est-ce qui peut expliquer la différence entre les deux bases de données ?**

La différence est due au fait que la base fishdb2 intègre les occurrences d'introduction par l'homme des poissons d'eau douce, ce qui masque les patrons naturels et change la forme des régions biogéographiques de poissons d'eau douce.


# 11. (facultatif) Faites une belle carte :) 

```{r}
library(lwgeom)
library(ggplot2)
library(rnaturalearth)

# On va utiliser la projection du National Geographic: Winkel Tripel
# Pour cela il faut utiliser le package lwgeom qui permet des projections additionnelles avec sf

# Graticule
gr <- sf::st_graticule(lat = c(-89.9,seq(-80,80,20), 89.9))
# Projection du graticule en wintri
gr <- st_transform_proj(gr, 
                        crs = "+proj=wintri")

# Trait de cote
wm <- ne_coastline(scale = 50, returnclass = "sf")
# Projection
wm <- st_transform_proj(wm, 
                        crs = "+proj=wintri")


# Projection des bassins en wintri
basins <- st_transform_proj(basins, 
                             crs = "+proj=wintri")

ggplot() +
  geom_sf(data = gr, color = 'grey', # graticule
          size = .5) +
  geom_sf(data = wm, col = grey(.6), fill = grey(.9), # continents
          size = .2) +
  geom_sf(data = basins, aes(fill = color1), # bassins avec couleurs des régions
          size = .05) +
  theme_minimal() + # thème simplifié pour ggplot2
  coord_sf(datum = NA) + # obligatoire pour pouvoir utiliser les projections de lwgeom
  scale_fill_identity()  # pour que ggplot utilise bien les couleurs qu'on lui demande

```


